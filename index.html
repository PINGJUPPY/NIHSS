<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIHSS Smart App</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS ตัวแปรสี */
        :root { --primary: #2563eb; --primary-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); --success: #10b981; --danger: #ef4444; --bg-color: #f1f5f9; --card-bg: rgba(255, 255, 255, 0.95); --text-main: #1e293b; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); padding-bottom: 70px; } /* เว้นที่ให้ Bottom Nav */
        
        /* Layout & Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .screen { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }
        
        /* Components */
        .glass-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; color: #475569; }
        input, select { width: 100%; padding: 12px 15px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-family: 'Sarabun'; font-size: 15px; background: #f8fafc; }
        input:focus { border-color: var(--primary); outline: none; background: white; }
        
        /* Buttons */
        .btn-primary { background: var(--primary-gradient); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 600; font-size: 16px; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Sarabun';}
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 15px; border-radius: 12px; font-weight: 600; width: 100%; cursor: pointer; margin-top: 10px; font-family: 'Sarabun';}

        /* Bottom Navigation Bar */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: none; justify-content: space-around; padding: 10px 0; z-index: 100; border-top-left-radius: 20px; border-top-right-radius: 20px;}
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 12px; cursor: pointer; transition: 0.3s; width: 33%;}
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }

        /* Modals & Score System */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .history-badge { background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 10px; font-size: 13px; color: #b45309; margin-top: 10px; display: none; }
        .compare-box { background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Score UI */
        .card-assess { border-left: 5px solid #cbd5e1; }
        .card-assess.completed { border-left-color: var(--success); background: #f0fdf4; }
        .score-group { display: flex; flex-direction: column; gap: 8px; }
        .score-btn { padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; text-align: left; font-size: 14px; display: flex; align-items: center; font-family: 'Sarabun';}
        .score-btn.active { background: #eff6ff; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .score-number { background: #f1f5f9; padding: 2px 8px; border-radius: 6px; margin-right: 10px; font-weight: bold; }
        .score-btn.active .score-number { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="loadingModal" class="modal-overlay"><div class="modal-content" style="width: auto;"><i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary);"></i><div style="margin-top:10px;">กำลังดำเนินการ...</div></div></div>
    
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <i id="alertIcon" class="fas fa-check-circle" style="font-size: 50px; margin-bottom: 15px;"></i>
            <div id="alertTitle" style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">แจ้งเตือน</div>
            <div id="alertBody" style="font-size: 15px; color: #64748b; margin-bottom: 20px;">...</div>
            <div id="compareContainer" class="compare-box" style="display: none;">
                <div><div style="font-size:12px;">ครั้งก่อน</div><span id="scoreOld" style="font-size:24px; font-weight:bold;">-</span></div>
                <div><i class="fas fa-arrow-right" style="color:#cbd5e1; font-size:20px;"></i></div>
                <div><div style="font-size:12px;">ครั้งนี้</div><span id="scoreNew" style="font-size:24px; font-weight:bold; color:var(--primary);">-</span></div>
            </div>
            <button class="btn-primary" onclick="document.getElementById('alertModal').style.display='none'">ตกลง</button>
        </div>
    </div>

    <datalist id="patientHnList"></datalist>
    <datalist id="patientNameList"></datalist>

    <nav class="bottom-nav" id="bottomNav">
        <div class="nav-item active" id="nav-menu" onclick="switchTab('screen-menu', 'nav-menu')">
            <i class="fas fa-home"></i>หน้าหลัก
        </div>
        <div class="nav-item" id="nav-app" onclick="switchTab('screen-app', 'nav-app')">
            <i class="fas fa-clipboard-check"></i>ประเมิน NIHSS
        </div>
        <div class="nav-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>ออกระบบ
        </div>
    </nav>

    <div id="screen-login" class="screen active" style="display: flex; flex-direction: column; justify-content: center; max-width: 400px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 30px;">
            <i class="fas fa-heartbeat" style="font-size: 50px; color: var(--primary);"></i>
            <h1 style="margin:0; font-size: 28px; color: var(--primary);">NIHSS Smart</h1>
        </div>
        <div class="glass-card">
            <div class="input-group"><label>เบอร์โทรศัพท์ (ใส่ 0 นำหน้าได้เลย)</label><input type="tel" id="logPhone" placeholder="เบอร์โทรที่ลงทะเบียน" maxlength="10"></div>
            <div class="input-group"><label>รหัส PIN</label><input type="password" id="logPin" placeholder="ระบุรหัส PIN 6 หลัก" maxlength="6" inputmode="numeric"></div>
            
            <button class="btn-primary" onclick="login()"><i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบด้วย PIN</button>
            <div style="text-align: center; margin-top: 20px;">
                <span style="color: var(--primary); cursor: pointer; text-decoration: underline;" onclick="document.getElementById('registerModal').style.display='flex'">สมัครสมาชิกใหม่</span>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-content" style="text-align: left; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: var(--primary); text-align: center; margin-top:0;">สร้างบัญชีผู้ใช้ใหม่</h2>
            <div class="input-group"><label>เบอร์โทรศัพท์ (ใช้เข้าระบบ)</label><input type="tel" id="regPhone" placeholder="08XXXXXXXX" maxlength="10"></div>
            <div class="input-group"><label>ชื่อ-นามสกุล</label><input type="text" id="regName" placeholder="เช่น นพ.ทดสอบ รักษาดี"></div>
            <div class="input-group"><label>ตั้งรหัส PIN (6 หลัก)</label><input type="password" id="regPin" placeholder="ตัวเลข 6 หลัก" maxlength="6" inputmode="numeric"></div>
            <div class="input-group">
                <label>ประเภทหน่วยงาน</label>
                <select id="regOrgType"><option>โรงพยาบาล</option><option>รพ.สต.</option><option>คลินิก</option><option>อื่นๆ</option></select>
            </div>
            <div class="input-group"><label>ชื่อหน่วยงาน</label><input type="text" id="regOrgName" placeholder="เช่น สะเดา"></div>
            <button class="btn-primary" onclick="register()"><i class="fas fa-user-plus"></i> สมัครสมาชิก</button>
            <button class="btn-outline" onclick="document.getElementById('registerModal').style.display='none'">ยกเลิก</button>
        </div>
    </div>

    <div id="screen-menu" class="screen" style="max-width: 400px; margin: 0 auto;">
        <div class="glass-card" style="text-align: center; background: var(--primary-gradient); color: white;">
            <i class="fas fa-user-md" style="font-size: 40px; margin-bottom: 10px;"></i>
            <h2 id="menuUserName" style="margin: 0;">ยินดีต้อนรับ</h2>
            <p id="menuOrgName" style="margin: 5px 0 0 0; opacity: 0.8; font-size: 14px;">-</p>
        </div>
        
        <div class="glass-card" style="padding: 15px;">
            <h3 style="margin-top:0; color:var(--text-main);">เมนูด่วน</h3>
            <button class="btn-primary" style="margin-bottom: 10px; padding: 20px; font-size: 16px;" onclick="switchTab('screen-app', 'nav-app')"><i class="fas fa-notes-medical" style="font-size: 20px;"></i> เริ่มประเมินคนไข้ (NIHSS)</button>
        </div>
    </div>

    <div id="screen-app" class="screen" style="max-width: 500px; margin: 0 auto;">
        <h3 style="margin-top:0; color:var(--primary);"><i class="fas fa-clipboard-list"></i> ฟอร์มประเมิน</h3>

        <div class="glass-card">
            <div class="input-group">
                <label>HN ผู้ป่วย <span style="color:red">*</span></label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="hn" list="patientHnList" placeholder="ระบุ HN" required oninput="autofillPatient('hn')">
                    <button class="btn-primary" style="width: auto; padding: 12px 20px;" onclick="checkHistory()"><i class="fas fa-search"></i></button>
                </div>
                <div id="historyInfo" class="history-badge"><i class="fas fa-info-circle"></i> ประวัติล่าสุด: <b id="lastScoreTxt">-</b> คะแนน (เมื่อ <span id="lastDateTxt">-</span>)</div>
            </div>
            <div class="input-group">
                <label>ชื่อ-สกุล ผู้ป่วย <span style="color:red">*</span></label>
                <input type="text" id="patientName" list="patientNameList" placeholder="ระบุชื่อผู้ป่วย" required oninput="autofillPatient('name')">
            </div>
        </div>

        <div class="glass-card" style="text-align: center; border: 2px solid var(--primary); position: sticky; top: 10px; z-index: 10;">
            <div style="font-size: 14px; color: #64748b; font-weight: 600;">คะแนนรวม (Total Score)</div>
            <div id="display-total" style="font-size: 36px; font-weight: bold; color: var(--primary);">0</div>
        </div>

        <div class="glass-card card-assess" id="card-1a">
            <h3 style="margin-top:0;">1a. Level of Consciousness</h3>
            <div class="score-group" id="group-1a">
                <button class="score-btn" type="button" onclick="selectScore('1a', 0)"><span class="score-number">0</span> Alert</button>
                <button class="score-btn" type="button" onclick="selectScore('1a', 1)"><span class="score-number">1</span> Drowsy</button>
                <button class="score-btn" type="button" onclick="selectScore('1a', 2)"><span class="score-number">2</span> Stuporous</button>
                <button class="score-btn" type="button" onclick="selectScore('1a', 3)"><span class="score-number">3</span> Coma</button>
            </div><input type="hidden" id="val_1a" class="nihss-val require-val">
        </div>

        <button class="btn-primary" style="margin-bottom: 20px; background: var(--success); padding: 20px;" onclick="saveAssessment()"><i class="fas fa-save" style="font-size: 20px;"></i> บันทึกข้อมูลประเมิน NIHSS</button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby-zXVnE-y_PqjIXTQ2HqK3H04J_u6rsbXwXZ_ffK9wNG8Tf4cdvHxPAP9YyKvWRlR4/exec';
        let currentUser = null;
        let previousScore = null;
        let patientDirectory = []; // เก็บรายชื่อคนไข้ที่ดึงมาตอน Login

        // --- Navigation Logic ---
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0,0);
        }

        function switchTab(screenId, navId) {
            switchScreen(screenId);
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(navId).classList.add('active');
        }

        function showAlert(type, title, msg, showCompare = false) {
            document.getElementById('loadingModal').style.display = 'none';
            const icon = document.getElementById('alertIcon');
            icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            icon.style.color = type === 'success' ? 'var(--success)' : 'var(--danger)';
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertBody').innerText = msg;
            
            if(showCompare && previousScore !== null) {
                document.getElementById('compareContainer').style.display = 'flex';
                document.getElementById('scoreOld').innerText = previousScore;
                document.getElementById('scoreNew').innerText = calculateTotal();
            } else { document.getElementById('compareContainer').style.display = 'none'; }
            
            document.getElementById('alertModal').style.display = 'flex';
        }

        // --- Auth Logic ---
        function register() {
            const phone = document.getElementById('regPhone').value;
            const pin = document.getElementById('regPin').value;
            if(!phone || !pin || pin.length < 6) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรุณากรอกเบอร์โทร และ PIN 6 หลัก');
            
            const payload = {
                action: "register", phone: phone, pin: pin,
                name: document.getElementById('regName').value,
                orgType: document.getElementById('regOrgType').value,
                orgName: document.getElementById('regOrgName').value
            };

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(res => {
                if(res.status === 'success') {
                    document.getElementById('registerModal').style.display = 'none';
                    showAlert('success', 'สำเร็จ', 'สมัครสมาชิกเรียบร้อย กรุณาเข้าสู่ระบบ');
                    document.getElementById('logPhone').value = phone;
                } else showAlert('error', 'ผิดพลาด', res.message);
            });
        }

        function login() {
            const phone = document.getElementById('logPhone').value;
            const pin = document.getElementById('logPin').value;
            if(!phone || !pin) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรุณากรอกเบอร์โทรและ PIN');

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: "login", phone: phone, pin: pin}) })
            .then(r => r.json()).then(res => {
                if(res.status === 'success') {
                    handleLoginSuccess(res);
                } else showAlert('error', 'ผิดพลาด', res.message);
            });
        }

        function handleLoginSuccess(userData) {
            document.getElementById('loadingModal').style.display = 'none';
            currentUser = userData;
            
            // นำรายชื่อคนไข้ที่โหลดมา ยัดใส่ Autocomplete Datalist
            patientDirectory = userData.patients || [];
            const hnList = document.getElementById('patientHnList');
            const nameList = document.getElementById('patientNameList');
            hnList.innerHTML = ''; nameList.innerHTML = '';
            
            patientDirectory.forEach(p => {
                hnList.innerHTML += `<option value="${p.hn}">${p.name}</option>`;
                nameList.innerHTML += `<option value="${p.name}">${p.hn}</option>`;
            });

            document.getElementById('menuUserName').innerText = "พยาบาล/แพทย์: " + userData.name;
            document.getElementById('menuOrgName').innerText = userData.orgType + " " + userData.orgName;
            document.getElementById('logPin').value = ''; 
            
            document.getElementById('bottomNav').style.display = 'flex'; // โชว์แถบเมนูด้านล่าง
            switchTab('screen-menu', 'nav-menu');
        }

        function logout() {
            currentUser = null;
            document.getElementById('bottomNav').style.display = 'none'; // ซ่อนเมนูด้านล่าง
            switchScreen('screen-login');
        }

        // --- Logic: Smart Autocomplete ---
        function autofillPatient(source) {
            const hnInput = document.getElementById('hn');
            const nameInput = document.getElementById('patientName');
            
            if(source === 'hn') {
                const matched = patientDirectory.find(p => p.hn === hnInput.value);
                if(matched) nameInput.value = matched.name;
            } else if (source === 'name') {
                const matched = patientDirectory.find(p => p.name === nameInput.value);
                if(matched) hnInput.value = matched.hn;
            }
        }

        // --- Logic: History ---
        function checkHistory() {
            const hn = document.getElementById('hn').value;
            if(!hn) return;
            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", hn: hn }) })
            .then(res => res.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                if(res.history && res.history.length > 0) {
                    previousScore = res.history[0].score;
                    const dateObj = new Date(res.history[0].date);
                    document.getElementById('lastScoreTxt').innerText = previousScore;
                    document.getElementById('lastDateTxt').innerText = dateObj.toLocaleDateString('th-TH') + " " + dateObj.getHours() + ":" + String(dateObj.getMinutes()).padStart(2, '0');
                    document.getElementById('historyInfo').style.display = 'block';
                } else {
                    previousScore = null;
                    document.getElementById('historyInfo').style.display = 'none';
                    showAlert('success', 'ไม่พบประวัติ', 'นี่คือการประเมินครั้งแรกของคนไข้รายนี้');
                }
            });
        }

        // --- Logic: Form & Score ---
        function selectScore(group, value) {
            document.querySelectorAll(`#group-${group} .score-btn`).forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${group}`).value = value;
            document.getElementById(`card-${group}`).classList.add('completed');
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.nihss-val').forEach(input => { if(input.value !== "") total += parseInt(input.value); });
            document.getElementById('display-total').innerText = total;
            return total;
        }

        function saveAssessment() {
            let isValid = true;
            document.querySelectorAll('.require-val').forEach(input => { if(input.value === "") isValid = false; });
            const hn = document.getElementById('hn').value;
            if(!hn || !isValid) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรุณากรอก HN และประเมินให้ครบทุกข้อ');

            const data = {
                hn: hn, patientName: document.getElementById('patientName').value,
                loc_1a: document.getElementById('val_1a').value, 
                // เพิ่มการรับค่าข้ออื่นๆ ตรงนี้...
                totalScore: calculateTotal(), assessorName: currentUser.name, orgFull: currentUser.orgType + " " + currentUser.orgName
            };

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "save", data: data }) })
            .then(res => res.json()).then(res => {
                showAlert('success', 'บันทึกสำเร็จ!', `ประเมิน HN: ${hn} เรียบร้อย`, true);
                
                // อัปเดตรายชื่อคนไข้ในเครื่องเผื่อเป็นคนไข้ใหม่ จะได้ Autocomplete ได้เลย
                if(!patientDirectory.find(p => p.hn === hn)) {
                    patientDirectory.push({hn: hn, name: data.patientName});
                    document.getElementById('patientHnList').innerHTML += `<option value="${hn}">${data.patientName}</option>`;
                    document.getElementById('patientNameList').innerHTML += `<option value="${data.patientName}">${hn}</option>`;
                }

                // Reset Form
                document.getElementById('historyInfo').style.display = 'none'; previousScore = null;
                document.getElementById('hn').value = ""; document.getElementById('patientName').value = "";
                document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.nihss-val').forEach(i => i.value = "");
                document.querySelectorAll('.card-assess').forEach(c => c.classList.remove('completed'));
                calculateTotal(); window.scrollTo(0,0);
            });
        }
    </script>
</body>
</html>
