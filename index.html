<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIHSS System - โรงพยาบาลสะเดา</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #0f766e; /* สีเขียวอมฟ้าแนวการแพทย์ */
            --primary-light: #14b8a6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-color: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --sidebar-width: 260px;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); overflow-x: hidden; }
        
        /* Layout Framework */
        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        
        /* Sidebar Navigation */
        .sidebar { width: var(--sidebar-width); background: var(--surface); border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 1000; }
        .sidebar-header { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #e5e7eb; }
        .sidebar-logo { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .sidebar-menu { padding: 15px 0; flex-grow: 1; }
        .menu-item { padding: 12px 25px; display: flex; align-items: center; gap: 15px; color: var(--text-muted); text-decoration: none; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .menu-item:hover { background: #f3f4f6; color: var(--primary); }
        .menu-item.active { background: #f0fdfa; color: var(--primary); border-right: 4px solid var(--primary); }
        .menu-item i { font-size: 18px; width: 25px; text-align: center; }
        .sidebar-footer { padding: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: var(--text-muted); text-align: center; }

        /* Main Content Area */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: var(--bg-color); }
        .topbar { background: var(--surface); height: 65px; min-height: 65px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        .hamburger { font-size: 22px; cursor: pointer; color: var(--text-muted); background: none; border: none; display: none; }
        .user-profile { display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
        
        /* Scrollable Content */
        .content-scroll { padding: 25px; overflow-y: auto; flex-grow: 1; padding-bottom: 100px; }

        /* Section Cards (การแยกสัดส่วน) */
        .section-card { background: var(--surface); border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 25px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .section-header { background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 10px; font-size: 16px; }
        .section-body { padding: 20px; }
        
        /* Forms & Inputs */
        .form-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-muted); }
        input, select { width: 100%; padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-family: 'Sarabun'; font-size: 15px; background: #f9fafb; transition: 0.3s; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1); }
        
        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 8px; font-family: 'Sarabun'; font-weight: 600; font-size: 15px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #115e59; }
        .btn-success { background: var(--success); color: white; width: 100%; padding: 15px; font-size: 18px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        
        /* Score UI */
        .assess-item { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #e5e7eb; }
        .assess-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .assess-title { font-weight: 600; color: var(--text-main); margin-bottom: 10px; font-size: 15px; }
        .score-group { display: flex; flex-direction: column; gap: 8px; }
        .score-btn { padding: 10px 15px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; text-align: left; font-size: 14px; cursor: pointer; display: flex; align-items: center; font-family: 'Sarabun'; transition: all 0.2s; }
        .score-btn.active { background: #f0fdfa; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .score-number { background: #f3f4f6; padding: 2px 8px; border-radius: 6px; margin-right: 12px; font-weight: bold; color: var(--text-muted); }
        .score-btn.active .score-number { background: var(--primary); color: white; }
        .split-col { display: flex; gap: 15px; }
        .split-col > div { flex: 1; }

        /* Floating Total Score */
        .sticky-score { position: sticky; top: -25px; background: var(--surface); padding: 15px 20px; border-radius: 12px; border: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* Dashboard Cards */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .dash-card { background: var(--surface); padding: 25px; border-radius: 12px; border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 20px; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: var(--primary-light); }
        .dash-icon { width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 28px; }

        /* Modals & Loaders */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(17, 24, 39, 0.7); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); height: 100vh; }
            .sidebar.show { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .hamburger { display: block; }
            .form-row { flex-direction: column; gap: 15px; }
            .split-col { flex-direction: column; }
        }

        /* Screens Hide/Show */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Login Screen (Full width) */
        #screen-login { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg-color); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { background: var(--surface); padding: 40px 30px; border-radius: 20px; width: 90%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
    </style>
</head>
<body>

    <div id="loadingModal" class="modal-overlay"><div class="modal-content" style="width: auto; padding: 20px;"><i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary);"></i><div style="margin-top:10px; font-weight: 500;">กำลังดำเนินการ...</div></div></div>
    
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <i id="alertIcon" class="fas fa-check-circle" style="font-size: 50px; margin-bottom: 15px;"></i>
            <h3 id="alertTitle" style="margin:0 0 10px 0;">แจ้งเตือน</h3>
            <p id="alertBody" style="color: var(--text-muted); margin-bottom: 20px;">...</p>
            <div id="compareContainer" style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; justify-content: space-around; align-items: center;">
                <div style="text-align: center;"><div style="font-size: 12px; color: #6b7280;">ครั้งก่อน</div><div id="scoreOld" style="font-size: 24px; font-weight: bold;">-</div></div>
                <i class="fas fa-arrow-right" style="color: #d1d5db;"></i>
                <div style="text-align: center;"><div style="font-size: 12px; color: #6b7280;">ครั้งนี้</div><div id="scoreNew" style="font-size: 24px; font-weight: bold; color: var(--primary);">-</div></div>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="document.getElementById('alertModal').style.display='none'">ตกลง</button>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 70px; height: 70px; background: var(--primary); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(15, 118, 110, 0.3);">
                <i class="fas fa-notes-medical" style="color: white; font-size: 35px;"></i>
            </div>
            <h1 style="margin: 0; color: var(--text-main); font-size: 24px;">ระบบประเมิน NIHSS</h1>
            <p style="margin: 5px 0 0 0; color: var(--text-muted);">โรงพยาบาลสะเดา จ.สงขลา</p>
        </div>
        
        <div class="login-box" id="box-login">
            <div class="form-group" style="text-align: left; margin-bottom: 15px;">
                <label>เบอร์โทรศัพท์เจ้าหน้าที่</label>
                <input type="tel" id="logPhone" placeholder="08XXXXXXXX" maxlength="10">
            </div>
            <div class="form-group" style="text-align: left; margin-bottom: 25px;">
                <label>รหัส PIN</label>
                <input type="password" id="logPin" placeholder="ระบุ PIN 6 หลัก" maxlength="6" inputmode="numeric">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="login()"><i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ</button>
            <span style="color: var(--primary); font-size: 14px; cursor: pointer; text-decoration: underline;" onclick="toggleAuth('register')">ลงทะเบียนเจ้าหน้าที่ใหม่</span>
        </div>

        <div class="login-box" id="box-register" style="display: none; text-align: left;">
            <h3 style="margin-top:0; text-align: center; color: var(--primary);">ลงทะเบียน</h3>
            <div class="form-group"><label>เบอร์โทร (Username)</label><input type="tel" id="regPhone" placeholder="08XXXXXXXX" maxlength="10"></div>
            <div class="form-group" style="margin-top: 10px;"><label>ชื่อ-นามสกุล</label><input type="text" id="regName" placeholder="นพ. / พย. ..."></div>
            <div class="form-group" style="margin-top: 10px;"><label>รหัส PIN 6 หลัก</label><input type="password" id="regPin" placeholder="ตั้งรหัสผ่าน" maxlength="6" inputmode="numeric"></div>
            <div class="form-row" style="margin-top: 10px; margin-bottom: 20px;">
                <div class="form-group"><label>หน่วยงาน</label>
                    <select id="regOrgType"><option>โรงพยาบาล</option><option>รพ.สต.</option><option>คลินิก</option></select>
                </div>
                <div class="form-group"><label>ชื่อหน่วยงาน</label><input type="text" id="regOrgName" placeholder="เช่น สะเดา"></div>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="register()"><i class="fas fa-user-plus"></i> สมัครสมาชิก</button>
            <div style="text-align: center;"><span style="color: var(--text-muted); font-size: 14px; cursor: pointer;" onclick="toggleAuth('login')"><i class="fas fa-arrow-left"></i> กลับไปหน้าเข้าสู่ระบบ</span></div>
        </div>
    </div>

    <div class="app-container" id="app-container" style="display: none;">
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-stethoscope"></i></div>
                <div>
                    <div style="font-weight: 600; font-size: 16px; color: var(--primary);">NIHSS App</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Palliative Care Style</div>
                </div>
            </div>
            <div class="sidebar-menu">
                <a class="menu-item active" id="nav-dashboard" onclick="navigate('dashboard')"><i class="fas fa-home"></i> หน้าหลัก (Dashboard)</a>
                <a class="menu-item" id="nav-form" onclick="navigate('form')"><i class="fas fa-file-medical"></i> บันทึกประเมินใหม่</a>
                <a class="menu-item" onclick="alert('ระบบดูประวัติย้อนหลัง (กำลังพัฒนาในเฟสถัดไป)')"><i class="fas fa-history"></i> ผู้ป่วยคงพยาบาล</a>
            </div>
            <div class="sidebar-footer">
                <a class="menu-item" style="color: var(--danger); justify-content: center;" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
                <div style="margin-top: 15px;">พัฒนาโดย: พท.ทศพร คงสุขนิรันดร์<br>รพ.สะเดา จ.สงขลา</div>
            </div>
        </div>

        <div class="main-content">
            <div class="topbar">
                <button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('show')"><i class="fas fa-bars"></i></button>
                <div style="flex-grow: 1; margin-left: 15px; font-weight: 600; color: var(--primary);" id="page-title">ระบบข้อมูลผู้ป่วย</div>
                <div class="user-profile">
                    <div style="text-align: right; display: none; @media(min-width: 600px){display: block;}">
                        <div id="topName" style="font-size: 14px;">เจ้าหน้าที่</div>
                        <div id="topOrg" style="font-size: 11px; color: var(--text-muted);">หน่วยงาน</div>
                    </div>
                    <div class="user-avatar"><i class="fas fa-user-md"></i></div>
                </div>
            </div>

            <div class="content-scroll">

                <datalist id="hnList"></datalist>
                <datalist id="nameList"></datalist>

                <div id="page-dashboard" class="screen active">
                    <h2 style="margin-top: 0; margin-bottom: 20px;">หน้าหลัก (Main Dashboard)</h2>
                    <div class="dash-grid">
                        <div class="dash-card" onclick="navigate('form')">
                            <div class="dash-icon" style="background: #ecfdf5; color: var(--success);"><i class="fas fa-user-plus"></i></div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">ประเมินรายใหม่</div>
                                <div style="font-size: 13px; color: var(--text-muted);">เปิดฟอร์มประเมิน NIHSS</div>
                            </div>
                        </div>
                        <div class="dash-card" onclick="alert('ตารางนัดหมาย')">
                            <div class="dash-icon" style="background: #eff6ff; color: #3b82f6;"><i class="fas fa-calendar-alt"></i></div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">ตารางติดตาม</div>
                                <div style="font-size: 13px; color: var(--text-muted);">ดูตารางนัดประเมินซ้ำ</div>
                            </div>
                        </div>
                        <div class="dash-card" onclick="alert('สรุปรายงาน')">
                            <div class="dash-icon" style="background: #fef2f2; color: var(--danger);"><i class="fas fa-chart-pie"></i></div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">สรุปรายงาน</div>
                                <div style="font-size: 13px; color: var(--text-muted);">ดูสถิติและ Export ข้อมูล</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-form" class="screen">
                    
                    <div class="sticky-score">
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); font-weight: 600;">Total Score</div>
                            <div style="font-weight: bold; color: var(--text-main);"><span id="display-total" style="font-size: 28px; color: var(--primary);">0</span> / 42</div>
                        </div>
                        <button class="btn btn-primary" onclick="saveAssessment()"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
                    </div>

                    <div class="section-card">
                        <div class="section-header"><i class="fas fa-address-card"></i> ข้อมูลทั่วไปของผู้ป่วย</div>
                        <div class="section-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>HN ผู้ป่วย <span style="color:red">*</span></label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="hn" list="hnList" placeholder="ระบุ HN" oninput="autofill('hn')">
                                        <button class="btn btn-primary" onclick="checkHistory()"><i class="fas fa-search"></i></button>
                                    </div>
                                    <div id="historyBadge" style="font-size: 13px; color: var(--warning); margin-top: 8px; font-weight: 500; display: none;">
                                        <i class="fas fa-history"></i> ประวัติล่าสุด: <span id="lastScoreTxt">-</span> คะแนน (วันที่ <span id="lastDateTxt">-</span>)
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>ชื่อ - สกุล <span style="color:red">*</span></label>
                                    <input type="text" id="patientName" list="nameList" placeholder="ระบุชื่อผู้ป่วย" oninput="autofill('name')">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header"><i class="fas fa-brain"></i> หมวด 1: การประเมินระดับความรู้สึกตัว (LOC)</div>
                        <div class="section-body">
                            
                            <div class="assess-item">
                                <div class="assess-title">1a. Level of Consciousness (ระดับความรู้สึกตัว)</div>
                                <div class="score-group" id="group-1a">
                                    <button class="score-btn" onclick="selectScore('1a', 0)"><span class="score-number">0</span> Alert (รู้สึกตัวดี)</button>
                                    <button class="score-btn" onclick="selectScore('1a', 1)"><span class="score-number">1</span> Drowsy (ซึม)</button>
                                    <button class="score-btn" onclick="selectScore('1a', 2)"><span class="score-number">2</span> Stuporous (ปลุกตื่นยาก)</button>
                                    <button class="score-btn" onclick="selectScore('1a', 3)"><span class="score-number">3</span> Coma (ไม่รู้สึกตัว)</button>
                                </div><input type="hidden" id="val_1a" class="nihss-val require-val">
                            </div>

                            <div class="assess-item">
                                <div class="assess-title">1b. LOC Questions (ถามอายุและเดือนปัจจุบัน)</div>
                                <div class="score-group" id="group-1b">
                                    <button class="score-btn" onclick="selectScore('1b', 0)"><span class="score-number">0</span> Both correct (ตอบถูก 2 คำถาม)</button>
                                    <button class="score-btn" onclick="selectScore('1b', 1)"><span class="score-number">1</span> One correct (ตอบถูก 1 คำถาม)</button>
                                    <button class="score-btn" onclick="selectScore('1b', 2)"><span class="score-number">2</span> None correct (ตอบผิดหมด)</button>
                                </div><input type="hidden" id="val_1b" class="nihss-val require-val">
                            </div>

                            <div class="assess-item">
                                <div class="assess-title">1c. LOC Commands (สั่งหลับตา-ลืมตา, กำมือ-แบมือ)</div>
                                <div class="score-group" id="group-1c">
                                    <button class="score-btn" onclick="selectScore('1c', 0)"><span class="score-number">0</span> Both correct (ทำตามได้ 2 อย่าง)</button>
                                    <button class="score-btn" onclick="selectScore('1c', 1)"><span class="score-number">1</span> One correct (ทำตามได้ 1 อย่าง)</button>
                                    <button class="score-btn" onclick="selectScore('1c', 2)"><span class="score-number">2</span> None correct (ทำไม่ได้เลย)</button>
                                </div><input type="hidden" id="val_1c" class="nihss-val require-val">
                            </div>

                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header"><i class="fas fa-eye"></i> หมวด 2: การมองเห็นและกล้ามเนื้อใบหน้า</div>
                        <div class="section-body">
                            
                            <div class="assess-item">
                                <div class="assess-title">2. Best Gaze (การเคลื่อนไหวของตาดำแนวนอน)</div>
                                <div class="score-group" id="group-2">
                                    <button class="score-btn" onclick="selectScore('2', 0)"><span class="score-number">0</span> Normal (ปกติ)</button>
                                    <button class="score-btn" onclick="selectScore('2', 1)"><span class="score-number">1</span> Partial gaze palsy (กรอกตาผิดปกติบางส่วน)</button>
                                    <button class="score-btn" onclick="selectScore('2', 2)"><span class="score-number">2</span> Forced eye deviation (ตาเบี่ยงสุดไปด้านใดด้านหนึ่ง)</button>
                                </div><input type="hidden" id="val_2" class="nihss-val require-val">
                            </div>

                            <div class="assess-item">
                                <div class="assess-title">3. Visual (ลานสายตา)</div>
                                <div class="score-group" id="group-3">
                                    <button class="score-btn" onclick="selectScore('3', 0)"><span class="score-number">0</span> No visual loss (มองเห็นปกติ)</button>
                                    <button class="score-btn" onclick="selectScore('3', 1)"><span class="score-number">1</span> Partial hemianopia (เสียลานสายตาบางส่วน)</button>
                                    <button class="score-btn" onclick="selectScore('3', 2)"><span class="score-number">2</span> Complete hemianopia (เสียลานสายตาซีกเดียว)</button>
                                    <button class="score-btn" onclick="selectScore('3', 3)"><span class="score-number">3</span> Bilateral hemianopia (ตาบอด / เสียลานสายตา 2 ข้าง)</button>
                                </div><input type="hidden" id="val_3" class="nihss-val require-val">
                            </div>

                            <div class="assess-item">
                                <div class="assess-title">4. Facial Palsy (กล้ามเนื้อใบหน้า ยิงฟัน ยิ้ม หลับตา)</div>
                                <div class="score-group" id="group-4">
                                    <button class="score-btn" onclick="selectScore('4', 0)"><span class="score-number">0</span> Normal (ปกติ)</button>
                                    <button class="score-btn" onclick="selectScore('4', 1)"><span class="score-number">1</span> Minor paralysis (อัมพาตเล็กน้อย)</button>
                                    <button class="score-btn" onclick="selectScore('4', 2)"><span class="score-number">2</span> Partial paralysis (อัมพาตครึ่งซีกส่วนล่าง)</button>
                                    <button class="score-btn" onclick="selectScore('4', 3)"><span class="score-number">3</span> Complete paralysis (อัมพาตครึ่งซีกทั้งบน-ล่าง)</button>
                                </div><input type="hidden" id="val_4" class="nihss-val require-val">
                            </div>

                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header"><i class="fas fa-running"></i> หมวด 3: กำลังกล้ามเนื้อ (Motor Arm & Leg)</div>
                        <div class="section-body">
                            
                            <div class="assess-item">
                                <div class="assess-title">5. Motor Arm (ตรวจกำลังแขน ยกค้าง 10 วินาที)</div>
                                <div class="split-col">
                                    <div>
                                        <div style="text-align:center; color:var(--danger); font-weight:600; margin-bottom:10px; padding:5px; background:#fef2f2; border-radius:5px;">แขนขวา (Right Arm)</div>
                                        <div class="score-group" id="group-5R">
                                            <button class="score-btn" onclick="selectScoreDual('5R', 0)">0: No drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('5R', 1)">1: Drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('5R', 2)">2: Some effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('5R', 3)">3: No effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('5R', 4)">4: No movement</button>
                                            <button class="score-btn" onclick="selectScoreDual('5R', 0)">X: Amputation (ตัดแขน)</button>
                                        </div><input type="hidden" id="val_5R" class="nihss-val require-val">
                                    </div>
                                    <div>
                                        <div style="text-align:center; color:var(--primary); font-weight:600; margin-bottom:10px; padding:5px; background:#f0fdfa; border-radius:5px;">แขนซ้าย (Left Arm)</div>
                                        <div class="score-group" id="group-5L">
                                            <button class="score-btn" onclick="selectScoreDual('5L', 0)">0: No drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('5L', 1)">1: Drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('5L', 2)">2: Some effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('5L', 3)">3: No effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('5L', 4)">4: No movement</button>
                                            <button class="score-btn" onclick="selectScoreDual('5L', 0)">X: Amputation (ตัดแขน)</button>
                                        </div><input type="hidden" id="val_5L" class="nihss-val require-val">
                                    </div>
                                </div>
                            </div>

                            <div class="assess-item">
                                <div class="assess-title">6. Motor Leg (ตรวจกำลังขา ยกค้าง 5 วินาที)</div>
                                <div class="split-col">
                                    <div>
                                        <div style="text-align:center; color:var(--danger); font-weight:600; margin-bottom:10px; padding:5px; background:#fef2f2; border-radius:5px;">ขาขวา (Right Leg)</div>
                                        <div class="score-group" id="group-6R">
                                            <button class="score-btn" onclick="selectScoreDual('6R', 0)">0: No drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('6R', 1)">1: Drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('6R', 2)">2: Some effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('6R', 3)">3: No effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('6R', 4)">4: No movement</button>
                                            <button class="score-btn" onclick="selectScoreDual('6R', 0)">X: Amputation (ตัดขา)</button>
                                        </div><input type="hidden" id="val_6R" class="nihss-val require-val">
                                    </div>
                                    <div>
                                        <div style="text-align:center; color:var(--primary); font-weight:600; margin-bottom:10px; padding:5px; background:#f0fdfa; border-radius:5px;">ขาซ้าย (Left Leg)</div>
                                        <div class="score-group" id="group-6L">
                                            <button class="score-btn" onclick="selectScoreDual('6L', 0)">0: No drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('6L', 1)">1: Drift</button>
                                            <button class="score-btn" onclick="selectScoreDual('6L', 2)">2: Some effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('6L', 3)">3: No effort</button>
                                            <button class="score-btn" onclick="selectScoreDual('6L', 4)">4: No movement</button>
                                            <button class="score-btn" onclick="selectScoreDual('6L', 0)">X: Amputation (ตัดขา)</button>
                                        </div><input type="hidden" id="val_6L" class="nihss-val require-val">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <button class="btn btn-success" onclick="saveAssessment()"><i class="fas fa-cloud-upload-alt"></i> บันทึกข้อมูลประเมินเข้าระบบ</button>

                </div>
            </div>
        </div>
    </div>

    <script>
        // ลิงก์ API ตัวเดิมของคุณหมอ ใช้งานได้เลย
        const API_URL = 'https://script.google.com/macros/s/AKfycby-zXVnE-y_PqjIXTQ2HqK3H04J_u6rsbXwXZ_ffK9wNG8Tf4cdvHxPAP9YyKvWRlR4/exec';
        let currentUser = null;
        let previousScore = null;
        let patientDirectory = [];

        // --- UI & Navigation ---
        function toggleAuth(type) {
            document.getElementById('box-login').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('box-register').style.display = type === 'register' ? 'block' : 'none';
        }

        function navigate(page) {
            // Update Sidebar Active state
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + page).classList.add('active');
            
            // Show content
            document.querySelectorAll('.main-content .screen').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            
            // Close sidebar on mobile
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('show');
            
            // Set Page Title
            const titles = { 'dashboard': 'หน้าหลัก', 'form': 'บันทึกประเมิน NIHSS' };
            document.getElementById('page-title').innerText = titles[page] || '';
            
            // Scroll to top
            document.querySelector('.content-scroll').scrollTo(0,0);
        }

        function showAlert(type, title, msg, showCompare = false) {
            document.getElementById('loadingModal').style.display = 'none';
            const icon = document.getElementById('alertIcon');
            icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            icon.style.color = type === 'success' ? 'var(--success)' : 'var(--danger)';
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertBody').innerText = msg;
            
            if(showCompare && previousScore !== null) {
                document.getElementById('compareContainer').style.display = 'flex';
                document.getElementById('scoreOld').innerText = previousScore;
                document.getElementById('scoreNew').innerText = calculateTotal();
            } else { document.getElementById('compareContainer').style.display = 'none'; }
            
            document.getElementById('alertModal').style.display = 'flex';
        }

        // --- Auth & Users ---
        function register() {
            const payload = {
                action: "register", phone: document.getElementById('regPhone').value, pin: document.getElementById('regPin').value,
                name: document.getElementById('regName').value, orgType: document.getElementById('regOrgType').value, orgName: document.getElementById('regOrgName').value
            };
            if(!payload.phone || payload.pin.length < 6) return showAlert('error', 'ข้อมูลไม่ครบ', 'ระบุเบอร์โทร และ PIN 6 หลัก');
            
            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(res => {
                if(res.status === 'success') {
                    showAlert('success', 'ลงทะเบียนสำเร็จ', 'กรุณาเข้าสู่ระบบด้วย PIN ที่ตั้งไว้');
                    document.getElementById('logPhone').value = payload.phone;
                    toggleAuth('login');
                } else showAlert('error', 'ผิดพลาด', res.message);
            });
        }

        function login() {
            const phone = document.getElementById('logPhone').value;
            const pin = document.getElementById('logPin').value;
            if(!phone || !pin) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรอกเบอร์โทรและ PIN ให้ครบถ้วน');

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: "login", phone: phone, pin: pin}) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                if(res.status === 'success') {
                    currentUser = res;
                    document.getElementById('topName').innerText = res.name;
                    document.getElementById('topOrg').innerText = res.orgType + " " + res.orgName;
                    
                    // Setup Autocomplete
                    patientDirectory = res.patients || [];
                    const hnList = document.getElementById('hnList'); const nameList = document.getElementById('nameList');
                    hnList.innerHTML = ''; nameList.innerHTML = '';
                    patientDirectory.forEach(p => { hnList.innerHTML += `<option value="${p.hn}">${p.name}</option>`; nameList.innerHTML += `<option value="${p.name}">${p.hn}</option>`; });
                    
                    document.getElementById('screen-login').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    navigate('dashboard');
                } else showAlert('error', 'เข้าสู่ระบบล้มเหลว', res.message);
            });
        }

        function logout() {
            document.getElementById('logPin').value = '';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('screen-login').style.display = 'flex';
        }

        // --- App Logic ---
        function autofill(source) {
            const hnInput = document.getElementById('hn'); const nameInput = document.getElementById('patientName');
            if(source === 'hn') {
                const matched = patientDirectory.find(p => p.hn === hnInput.value); if(matched) nameInput.value = matched.name;
            } else if (source === 'name') {
                const matched = patientDirectory.find(p => p.name === nameInput.value); if(matched) hnInput.value = matched.hn;
            }
        }

        function checkHistory() {
            const hn = document.getElementById('hn').value; if(!hn) return;
            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", hn: hn }) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                if(res.history && res.history.length > 0) {
                    previousScore = res.history[0].score;
                    const dateObj = new Date(res.history[0].date);
                    document.getElementById('lastScoreTxt').innerText = previousScore;
                    document.getElementById('lastDateTxt').innerText = dateObj.toLocaleDateString('th-TH');
                    document.getElementById('historyBadge').style.display = 'block';
                } else {
                    previousScore = null; document.getElementById('historyBadge').style.display = 'none';
                    showAlert('success', 'ผู้ป่วยใหม่', 'ไม่พบประวัติการประเมิน NIHSS ของคนไข้รายนี้');
                }
            });
        }

        function selectScore(group, value) {
            document.querySelectorAll(`#group-${group} .score-btn`).forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${group}`).value = value;
            calculateTotal();
        }

        function selectScoreDual(subGroup, value) {
            document.querySelectorAll(`#group-${subGroup} .score-btn`).forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${subGroup}`).value = value;
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.nihss-val').forEach(input => { if(input.value !== "") total += parseInt(input.value); });
            document.getElementById('display-total').innerText = total;
            return total;
        }

        function saveAssessment() {
            let isValid = true; document.querySelectorAll('.require-val').forEach(input => { if(input.value === "") isValid = false; });
            const hn = document.getElementById('hn').value;
            if(!hn || !isValid) return showAlert('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลให้ครบทุกช่องในฟอร์มประเมิน');

            const data = {
                hn: hn, patientName: document.getElementById('patientName').value,
                loc_1a: document.getElementById('val_1a').value, loc_1b: document.getElementById('val_1b').value, loc_1c: document.getElementById('val_1c').value,
                gaze_2: document.getElementById('val_2').value, visual_3: document.getElementById('val_3').value, facial_4: document.getElementById('val_4').value,
                motorArm_R: document.getElementById('val_5R').value, motorArm_L: document.getElementById('val_5L').value,
                motorLeg_R: document.getElementById('val_6R').value, motorLeg_L: document.getElementById('val_6L').value,
                totalScore: calculateTotal(), assessorName: currentUser.name, orgFull: currentUser.orgType + " " + currentUser.orgName
            };

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "save", data: data }) }).then(r => r.json()).then(res => {
                showAlert('success', 'บันทึกสำเร็จ', `ข้อมูล HN: ${hn} จัดเก็บเข้าระบบเรียบร้อยแล้ว`, true);
                
                // อัปเดตรายชื่อใหม่ถ้ายังไม่มี
                if(!patientDirectory.find(p => p.hn === hn)) {
                    patientDirectory.push({hn: hn, name: data.patientName});
                    document.getElementById('hnList').innerHTML += `<option value="${hn}">${data.patientName}</option>`;
                    document.getElementById('nameList').innerHTML += `<option value="${data.patientName}">${hn}</option>`;
                }

                // Reset
                document.getElementById('historyBadge').style.display = 'none'; previousScore = null;
                document.getElementById('hn').value = ""; document.getElementById('patientName').value = "";
                document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.nihss-val').forEach(i => i.value = "");
                calculateTotal(); document.querySelector('.content-scroll').scrollTo(0,0);
            });
        }
    </script>
</body>
</html>
