<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIHSS Smart App</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            --success: #10b981;
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

        /* General Layout */
        .screen { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }
        
        /* Modern Cards */
        .glass-card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 16px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); animation: slideUp 0.5s ease-out backwards; }
        
        /* Inputs & Buttons */
        .input-group { margin-bottom: 15px; text-align: left; }
        label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; color: #475569; }
        input, select { width: 100%; padding: 12px 15px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-family: 'Sarabun'; font-size: 15px; transition: 0.3s; background: #f8fafc; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; background: white; }
        
        .btn-primary { background: var(--primary-gradient); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 600; font-size: 16px; width: 100%; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); font-family: 'Sarabun'; }
        .btn-primary:active { transform: scale(0.98); }
        .text-link { color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: 600; text-align: center; display: block; margin-top: 15px; }

        /* Header */
        .app-header { background: var(--primary-gradient); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(37,99,235,0.2); text-align: center; animation: slideUp 0.3s ease-out; }
        .app-header h2 { margin: 0; font-size: 22px; }
        .app-header p { margin: 5px 0 0 0; font-size: 14px; opacity: 0.9; }

        /* Assessment UI */
        .card-assess { border-left: 5px solid #cbd5e1; transition: 0.3s; }
        .card-assess.completed { border-left-color: var(--success); background: #f0fdf4; }
        .score-group { display: flex; flex-direction: column; gap: 8px; }
        .score-btn { padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; text-align: left; font-size: 14px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; font-family: 'Sarabun'; }
        .score-btn.active { background: #eff6ff; border-color: var(--primary); color: var(--primary); font-weight: 600; box-shadow: inset 0 0 0 1px var(--primary); }
        .score-number { background: #f1f5f9; padding: 2px 8px; border-radius: 6px; margin-right: 10px; font-weight: bold; }
        .score-btn.active .score-number { background: var(--primary); color: white; }

        /* History Badge */
        .history-badge { background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 10px; font-size: 13px; color: #b45309; margin-top: 10px; display: none; }

        /* Custom Modal (Pop-up) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-icon { font-size: 50px; margin-bottom: 15px; }
        .modal-icon.success { color: var(--success); }
        .modal-icon.error { color: #ef4444; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .modal-body { font-size: 15px; color: #64748b; margin-bottom: 25px; line-height: 1.5; }
        
        /* Compare Box inside Modal */
        .compare-box { background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .compare-item { flex: 1; }
        .compare-item div { font-size: 12px; color: #64748b; }
        .compare-item span { font-size: 24px; font-weight: bold; color: var(--text-main); }
        .compare-arrow { font-size: 20px; color: #cbd5e1; }
    </style>
</head>
<body>

    <div id="loadingModal" class="modal-overlay">
        <div class="modal-content" style="padding: 20px; width: auto;">
            <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary);"></i>
            <div style="margin-top: 10px; font-weight: 600;">กำลังดำเนินการ...</div>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <i id="alertIcon" class="fas modal-icon"></i>
            <div id="alertTitle" class="modal-title">แจ้งเตือน</div>
            <div id="alertBody" class="modal-body">รายละเอียด...</div>
            <div id="compareContainer" class="compare-box" style="display: none;">
                <div class="compare-item"><div>ครั้งก่อน</div><span id="scoreOld">-</span></div>
                <div class="compare-arrow"><i class="fas fa-arrow-right"></i></div>
                <div class="compare-item"><div>ครั้งนี้</div><span id="scoreNew" style="color: var(--primary);">-</span></div>
            </div>
            <button class="btn-primary" onclick="closeModal()">ตกลง</button>
        </div>
    </div>

    <div id="screen-login" class="screen active" style="display: flex; flex-direction: column; justify-content: center; max-width: 400px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 30px; animation: slideUp 0.4s;">
            <i class="fas fa-heartbeat" style="font-size: 50px; color: var(--primary); margin-bottom: 10px;"></i>
            <h1 style="margin:0; font-size: 28px; color: var(--primary);">NIHSS Smart</h1>
            <p style="color: #64748b; margin: 5px 0 0 0;">เข้าสู่ระบบเจ้าหน้าที่</p>
        </div>
        <div class="glass-card">
            <div class="input-group">
                <label>ชื่อ-นามสกุล</label>
                <input type="text" id="logName" placeholder="ระบุชื่อผู้ใช้งาน">
            </div>
            <div class="input-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="logPass" placeholder="ระบุรหัสผ่าน">
            </div>
            <button class="btn-primary" onclick="login()">เข้าสู่ระบบ</button>
            <span class="text-link" onclick="switchScreen('screen-register')">สมัครสมาชิกใหม่</span>
        </div>
        <div style="text-align: center; font-size: 13px; color: #94a3b8;">พบปัญหาติดต่อ 080-000-0000</div>
    </div>

    <div id="screen-register" class="screen" style="max-width: 400px; margin: 0 auto;">
        <h2 style="color: var(--primary); text-align: center; margin-top: 30px;">สร้างบัญชีผู้ใช้</h2>
        <div class="glass-card">
            <div class="input-group">
                <label>ชื่อ-นามสกุล</label>
                <input type="text" id="regName" placeholder="เช่น นพ.ทดสอบ รักษาดี">
            </div>
            <div class="input-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="regPass" placeholder="ตั้งรหัสผ่าน">
            </div>
            <div class="input-group">
                <label>ประเภทหน่วยงาน</label>
                <select id="regOrgType">
                    <option value="โรงพยาบาล">โรงพยาบาล</option>
                    <option value="รพ.สต.">รพ.สต.</option>
                    <option value="คลินิก">คลินิก</option>
                    <option value="อื่นๆ">อื่นๆ</option>
                </select>
            </div>
            <div class="input-group">
                <label>ชื่อหน่วยงาน</label>
                <input type="text" id="regOrgName" placeholder="เช่น สะเดา">
            </div>
            <div class="input-group">
                <label>เบอร์โทรศัพท์ (สำรอง)</label>
                <input type="tel" id="regPhone" placeholder="08XXXXXXXX">
            </div>
            <button class="btn-primary" onclick="register()">ยืนยันการสมัคร</button>
            <span class="text-link" onclick="switchScreen('screen-login')"><i class="fas fa-arrow-left"></i> กลับไปหน้าเข้าสู่ระบบ</span>
        </div>
    </div>

    <div id="screen-app" class="screen" style="max-width: 500px; margin: 0 auto;">
        <div class="app-header">
            <h2 id="displayUser">NIHSS Form</h2>
            <p id="displayOrg">กำลังโหลดข้อมูล...</p>
        </div>

        <div class="glass-card">
            <div class="input-group">
                <label>HN ผู้ป่วย <span style="color:red">*</span></label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="hn" placeholder="ระบุ HN" required>
                    <button class="btn-primary" style="width: auto; padding: 12px 20px;" onclick="checkHistory()"><i class="fas fa-search"></i></button>
                </div>
                <div id="historyInfo" class="history-badge">
                    <i class="fas fa-info-circle"></i> ประวัติล่าสุด: <b id="lastScoreTxt">-</b> คะแนน (เมื่อ <span id="lastDateTxt">-</span>)
                </div>
            </div>
            <div class="input-group">
                <label>ชื่อ-สกุล ผู้ป่วย <span style="color:red">*</span></label>
                <input type="text" id="patientName" placeholder="ระบุชื่อผู้ป่วย" required>
            </div>
        </div>

        <div class="glass-card" style="text-align: center; border: 2px solid var(--primary);">
            <div style="font-size: 14px; color: #64748b; font-weight: 600;">คะแนนรวม (Total Score)</div>
            <div id="display-total" style="font-size: 36px; font-weight: bold; color: var(--primary);">0</div>
        </div>

        <div class="glass-card card-assess" id="card-1a">
            <h3>1a. Level of Consciousness</h3>
            <div class="score-group" id="group-1a">
                <button class="score-btn" onclick="selectScore('1a', 0)"><span class="score-number">0</span> Alert</button>
                <button class="score-btn" onclick="selectScore('1a', 1)"><span class="score-number">1</span> Drowsy</button>
                <button class="score-btn" onclick="selectScore('1a', 2)"><span class="score-number">2</span> Stuporous</button>
                <button class="score-btn" onclick="selectScore('1a', 3)"><span class="score-number">3</span> Coma</button>
            </div>
            <input type="hidden" id="val_1a" class="nihss-val require-val" value="">
        </div>

        <button class="btn-primary" style="margin-bottom: 40px; background: var(--success); box-shadow: 0 4px 15px rgba(16,185,129,0.3);" onclick="saveAssessment()"><i class="fas fa-save"></i> บันทึกข้อมูลประเมิน</button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby-zXVnE-y_PqjIXTQ2HqK3H04J_u6rsbXwXZ_ffK9wNG8Tf4cdvHxPAP9YyKvWRlR4/exec';
        let currentUser = {};
        let previousScore = null;

        // --- Navigation ---
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0,0);
        }

        // --- UI Modals ---
        function showLoading(show) {
            document.getElementById('loadingModal').style.display = show ? 'flex' : 'none';
        }
        function showAlert(type, title, msg, showCompare = false) {
            const icon = document.getElementById('alertIcon');
            icon.className = type === 'success' ? 'fas fa-check-circle modal-icon success' : 'fas fa-exclamation-circle modal-icon error';
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertBody').innerText = msg;
            
            if(showCompare && previousScore !== null) {
                document.getElementById('compareContainer').style.display = 'flex';
                document.getElementById('scoreOld').innerText = previousScore;
                document.getElementById('scoreNew').innerText = calculateTotal();
            } else {
                document.getElementById('compareContainer').style.display = 'none';
            }

            document.getElementById('alertModal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        // --- Logic: Auth ---
        function register() {
            const payload = {
                action: "register",
                name: document.getElementById('regName').value,
                password: document.getElementById('regPass').value,
                orgType: document.getElementById('regOrgType').value,
                orgName: document.getElementById('regOrgName').value,
                phone: document.getElementById('regPhone').value
            };
            if(!payload.name || !payload.password) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรุณากรอกชื่อและรหัสผ่าน');
            
            showLoading(true);
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json()).then(res => {
                showLoading(false);
                if(res.status === 'success') {
                    showAlert('success', 'สำเร็จ', 'สมัครสมาชิกเรียบร้อย กรุณาเข้าสู่ระบบ');
                    switchScreen('screen-login');
                } else showAlert('error', 'ผิดพลาด', res.message);
            });
        }

        function login() {
            const payload = {
                action: "login",
                name: document.getElementById('logName').value,
                password: document.getElementById('logPass').value
            };
            if(!payload.name || !payload.password) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลให้ครบถ้วน');

            showLoading(true);
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json()).then(res => {
                showLoading(false);
                if(res.status === 'success') {
                    currentUser = res;
                    document.getElementById('displayUser').innerText = "พยาบาล/แพทย์: " + res.name;
                    document.getElementById('displayOrg').innerText = res.orgType + " " + res.orgName;
                    switchScreen('screen-app');
                } else showAlert('error', 'ผิดพลาด', res.message);
            });
        }

        // --- Logic: History ---
        function checkHistory() {
            const hn = document.getElementById('hn').value;
            if(!hn) return;
            showLoading(true);
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", hn: hn }) })
            .then(res => res.json()).then(res => {
                showLoading(false);
                if(res.history && res.history.length > 0) {
                    const lastRecord = res.history[0];
                    previousScore = lastRecord.score;
                    const dateObj = new Date(lastRecord.date);
                    const dateStr = dateObj.toLocaleDateString('th-TH') + " " + dateObj.getHours() + ":" + String(dateObj.getMinutes()).padStart(2, '0');
                    
                    document.getElementById('lastScoreTxt').innerText = previousScore;
                    document.getElementById('lastDateTxt').innerText = dateStr;
                    document.getElementById('historyInfo').style.display = 'block';
                } else {
                    previousScore = null;
                    document.getElementById('historyInfo').style.display = 'none';
                    showAlert('success', 'ไม่พบประวัติ', 'นี่คือการประเมินครั้งแรกของคนไข้รายนี้');
                }
            });
        }

        // --- Logic: Assessment Form (ตัวอย่าง) ---
        function selectScore(group, value) {
            const buttons = document.querySelectorAll(`#group-${group} .score-btn`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${group}`).value = value;
            document.getElementById(`card-${group}`).classList.add('completed');
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.nihss-val').forEach(input => {
                if(input.value !== "") total += parseInt(input.value);
            });
            document.getElementById('display-total').innerText = total;
            return total;
        }

        function saveAssessment() {
            const hn = document.getElementById('hn').value;
            if(!hn) return showAlert('error', 'ข้อมูลไม่ครบ', 'กรุณาระบุ HN ผู้ป่วย');

            const data = {
                hn: hn, patientName: document.getElementById('patientName').value,
                loc_1a: document.getElementById('val_1a').value,
                // (ถ้าเพิ่มข้ออื่น ต้องมารับค่าตรงนี้ด้วยนะครับ)
                totalScore: calculateTotal(),
                assessorName: currentUser.name,
                orgFull: currentUser.orgType + " " + currentUser.orgName
            };

            showLoading(true);
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "save", data: data }) })
            .then(res => res.json()).then(res => {
                showLoading(false);
                // โชว์ Pop-up สุดล้ำ ที่มีตารางเปรียบเทียบคะแนนเก่า-ใหม่
                showAlert('success', 'บันทึกสำเร็จ!', `ข้อมูลผู้ป่วย HN: ${hn} ถูกจัดเก็บลงฐานข้อมูลแล้ว`, true);
                
                // รีเซ็ตฟอร์ม (ลบ history เก่าทิ้ง เตรียมรับคนใหม่)
                document.getElementById('historyInfo').style.display = 'none';
                previousScore = null;
                document.getElementById('hn').value = "";
                document.getElementById('patientName').value = "";
                document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.nihss-val').forEach(i => i.value = "");
                document.querySelectorAll('.card-assess').forEach(c => c.classList.remove('completed'));
                calculateTotal();
                window.scrollTo(0,0);
            });
        }
    </script>
</body>
</html>
