<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึก NIHSS - โรงพยาบาลสะเดา</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #0f766e;
            --primary-dark: #115e59;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --bg-surface: #ffffff;
            --text-dark: #1f2937;
            --border: #e5e7eb;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-body); margin: 0; padding: 0; color: var(--text-dark); }
        .screen { display: none; padding-bottom: 50px; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Login Screen */
        .login-wrapper { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: var(--bg-surface); width: 90%; max-width: 400px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); text-align: center; }

        /* Topbar & Sticky Header */
        .sticky-header { position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .topbar { background: #1e293b; color: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .topbar-brand { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .topbar-actions { display: flex; gap: 10px; }
        
        .patient-banner { background: var(--bg-surface); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .patient-info h2 { margin: 0; color: var(--primary-dark); font-size: 18px; }
        .patient-info p { margin: 5px 0 0 0; color: var(--secondary); font-size: 14px; }

        /* Custom Autocomplete UX/UI */
        .autocomplete-wrapper { position: relative; width: 100%; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 999; display: none; }
        .autocomplete-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 15px; }
        .autocomplete-item:hover { background: #f0fdfa; color: var(--primary); }

        /* Forms & Cards */
        .container { max-width: 800px; margin: 30px auto; padding: 0 20px; }
        .card { background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #f8fafc; font-weight: 600; font-size: 16px; color: var(--primary-dark); }
        .card-body { padding: 20px; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--secondary); }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Sarabun'; font-size: 16px; box-sizing: border-box; transition: 0.2s; background: #f8fafc; }
        .form-control:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1); }
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }

        /* Buttons */
        .btn { padding: 10px 16px; border-radius: 6px; font-family: 'Sarabun'; font-size: 15px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; justify-content: center; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; padding: 15px; font-size: 18px; width: 100%; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: #fca5a5; color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-dark); }
        .btn-outline-light { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }
        .btn-outline-light:hover { background: rgba(255,255,255,0.1); }

        /* Score Buttons */
        .score-row { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed var(--border); }
        .score-row:last-child { border: none; margin: 0; padding: 0; }
        .score-options { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .score-btn { padding: 10px 15px; border: 1px solid var(--border); background: white; border-radius: 8px; text-align: left; cursor: pointer; font-family: 'Sarabun'; font-size: 15px; display: flex; align-items: center; }
        .score-btn.active { background: #f0fdfa; border-color: var(--primary); color: var(--primary-dark); font-weight: 600; }
        .score-num { background: #f1f5f9; padding: 2px 8px; border-radius: 6px; margin-right: 12px; font-weight: bold; color: var(--secondary); }
        .score-btn.active .score-num { background: var(--primary); color: white; }

        /* Modals */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 14px; text-align: center; }
        th, td { padding: 10px; border: 1px solid var(--border); }
        th { background: #f8fafc; font-weight: 600; color: var(--secondary); }
        .badge { background: #fee2e2; color: #b91c1c; padding: 3px 8px; border-radius: 12px; font-weight: bold; }

        /* --- Print / PDF Export CSS --- */
        @media print {
            body { background: white; color: black; }
            .sticky-header, .btn, .topbar, #page-search, .score-options button:not(.active) { display: none !important; }
            .card { box-shadow: none; border: 1px solid #000; break-inside: avoid; }
            .modal { position: static; display: block; background: transparent; }
            .modal-content { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; }
            #historyModal .btn { display: none; } /* ซ่อนปุ่มในหน้า Print */
            @page { margin: 1cm; size: A4 portrait; }
        }
    </style>
</head>
<body>

    <div id="loadingModal" class="modal" style="z-index: 9999;"><div class="modal-content" style="width:auto; text-align:center;"><i class="fas fa-spinner fa-spin" style="font-size: 35px; color: var(--primary); margin-bottom:15px;"></i><div style="font-weight: 500;">กำลังประมวลผล...</div></div></div>

    <div id="screen-login" class="screen active">
        <div class="login-wrapper">
            <div class="login-card">
                <i class="fas fa-hospital-user" style="font-size: 50px; color: var(--primary); margin-bottom: 15px;"></i>
                <h2 style="color: var(--text-dark); margin:0;">NIHSS System</h2>
                <p style="color: var(--secondary); margin: 5px 0 25px 0; font-size: 14px;">โรงพยาบาลสะเดา จ.สงขลา</p>
                
                <div id="form-login">
                    <div class="form-group">
                        <input type="tel" id="logPhone" class="form-control" placeholder="เบอร์โทรศัพท์ (Username)" maxlength="10" style="text-align: center;">
                    </div>
                    <div class="form-group">
                        <input type="password" id="logPin" class="form-control" placeholder="รหัส PIN 6 หลัก" maxlength="6" inputmode="numeric" oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6);" style="text-align: center; font-size: 20px; letter-spacing: 5px;">
                    </div>
                    <button class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 10px;" onclick="login()"><i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ</button>
                    <div style="margin-top: 20px; font-size: 14px;">
                        <span style="color: var(--secondary); cursor: pointer; text-decoration: underline;" onclick="toggleAuth('register')">ลงทะเบียนเจ้าหน้าที่ใหม่</span>
                    </div>
                </div>

                <div id="form-register" style="display: none; text-align: left;">
                    <div class="form-group"><label class="form-label">เบอร์โทรศัพท์</label><input type="tel" id="regPhone" class="form-control" placeholder="08XXXXXXXX" maxlength="10"></div>
                    <div class="form-group"><label class="form-label">ชื่อ - สกุล</label><input type="text" id="regName" class="form-control" placeholder="นพ. / พย. ..."></div>
                    <div class="form-group"><label class="form-label">ตั้งรหัส PIN 6 หลัก</label><input type="password" id="regPin" class="form-control" maxlength="6" inputmode="numeric" oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6);"></div>
                    <div class="row">
                        <div class="col form-group">
                            <label class="form-label">หน่วยงาน</label>
                            <select id="regOrgType" class="form-control"><option>โรงพยาบาล</option><option>รพ.สต.</option><option>คลินิก</option></select>
                        </div>
                        <div class="col form-group"><label class="form-label">ชื่อหน่วยงาน</label><input type="text" id="regOrgName" class="form-control" placeholder="เช่น สะเดา"></div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="register()">บันทึกการลงทะเบียน</button>
                    <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="toggleAuth('login')">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-layout" style="display: none;">
        
        <div class="sticky-header">
            <div class="topbar">
                <div class="topbar-brand">
                    <i class="fas fa-stethoscope"></i> NIHSS
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-outline-light" onclick="navigate('search')"><i class="fas fa-home"></i> ค้นหาผู้ป่วย</button>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</button>
                </div>
            </div>
            
            <div id="patientBanner" class="patient-banner" style="display: none;">
                <div class="patient-info">
                    <h2 id="bannerHnName">HN: - | ชื่อผู้ป่วย: -</h2>
                    <p id="bannerHistoryText">กำลังดึงข้อมูล...</p>
                </div>
                <div>
                    <button class="btn btn-outline" onclick="showHistory()"><i class="fas fa-folder-open"></i> เปิดแฟ้มประวัติ</button>
                </div>
            </div>
        </div>

        <div id="page-search" class="screen active container">
            <div style="text-align: center; margin-bottom: 30px; margin-top: 20px;">
                <h2 style="color: var(--primary-dark); margin:0;">ระบุตัวผู้ป่วย</h2>
                <p style="color: var(--secondary);">กรุณากรอก HN หรือ ชื่อ-สกุล เพื่อเริ่มประเมิน</p>
            </div>
            <div class="card" style="max-width: 600px; margin: 0 auto; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">HN ผู้ป่วย</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="searchHn" class="form-control" placeholder="พิมพ์ HN..." onkeyup="filterAutocomplete('hn')" onclick="filterAutocomplete('hn')">
                            <div id="dropdownHn" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <div style="text-align: center; color: #cbd5e1; margin: 15px 0;">--- หรือ ---</div>
                    <div class="form-group">
                        <label class="form-label">ชื่อ - สกุล ผู้ป่วย</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="searchName" class="form-control" placeholder="พิมพ์ชื่อ..." onkeyup="filterAutocomplete('name')" onclick="filterAutocomplete('name')">
                            <div id="dropdownName" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px; margin-top: 15px;" onclick="proceedToAssessment()"><i class="fas fa-arrow-right"></i> ยืนยัน และดำเนินการต่อ</button>
                </div>
            </div>
        </div>

        <div id="page-assess" class="screen container">
            
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 14px; color: var(--secondary); font-weight: 600;">คะแนนรวม (Total Score)</div>
                <div id="display-total" style="font-size: 40px; font-weight: bold; color: var(--primary);">0</div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-brain"></i> หมวด 1: การประเมินระดับความรู้สึกตัว (LOC)</div>
                <div class="card-body">
                    <div class="score-row">
                        <label class="form-label">1a. Level of Consciousness</label>
                        <div class="score-options" id="group-1a">
                            <button class="score-btn" onclick="selectScore('1a', 0)"><span class="score-num">0</span> Alert</button>
                            <button class="score-btn" onclick="selectScore('1a', 1)"><span class="score-num">1</span> Drowsy</button>
                            <button class="score-btn" onclick="selectScore('1a', 2)"><span class="score-num">2</span> Stuporous</button>
                            <button class="score-btn" onclick="selectScore('1a', 3)"><span class="score-num">3</span> Coma</button>
                        </div><input type="hidden" id="val_1a" class="nihss-val require-val">
                    </div>
                    </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-eye"></i> หมวด 2: การมองเห็นและกล้ามเนื้อใบหน้า</div>
                <div class="card-body">
                    <div class="score-row">
                        <label class="form-label">2. Best Gaze</label>
                        <div class="score-options" id="group-2">
                            <button class="score-btn" onclick="selectScore('2', 0)"><span class="score-num">0</span> Normal</button>
                            <button class="score-btn" onclick="selectScore('2', 1)"><span class="score-num">1</span> Partial gaze palsy</button>
                            <button class="score-btn" onclick="selectScore('2', 2)"><span class="score-num">2</span> Forced eye deviation</button>
                        </div><input type="hidden" id="val_2" class="nihss-val require-val">
                    </div>
                    </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-running"></i> หมวด 3: กำลังกล้ามเนื้อ (Motor)</div>
                <div class="card-body">
                    <div class="score-row">
                        <label class="form-label">5. Motor Arm (แขน)</label>
                        <div class="row">
                            <div class="col">
                                <div style="background:#fef2f2; padding:5px; text-align:center; border-radius:4px; font-weight:600; color:var(--danger); margin-bottom:10px;">ขวา (R)</div>
                                <div class="score-options" id="group-5R">
                                    <button class="score-btn" onclick="selectScoreDual('5R', 0)">0: No drift</button>
                                    <button class="score-btn" onclick="selectScoreDual('5R', 1)">1: Drift</button>
                                    <button class="score-btn" onclick="selectScoreDual('5R', 2)">2: Some effort</button>
                                    <button class="score-btn" onclick="selectScoreDual('5R', 3)">3: No effort</button>
                                    <button class="score-btn" onclick="selectScoreDual('5R', 4)">4: No movement</button>
                                    <button class="score-btn" onclick="selectScoreDual('5R', 0)">X: Amputation</button>
                                </div><input type="hidden" id="val_5R" class="nihss-val require-val">
                            </div>
                            <div class="col">
                                <div style="background:#f0fdfa; padding:5px; text-align:center; border-radius:4px; font-weight:600; color:var(--primary); margin-bottom:10px;">ซ้าย (L)</div>
                                <div class="score-options" id="group-5L">
                                    <button class="score-btn" onclick="selectScoreDual('5L', 0)">0: No drift</button>
                                    <button class="score-btn" onclick="selectScoreDual('5L', 1)">1: Drift</button>
                                    <button class="score-btn" onclick="selectScoreDual('5L', 2)">2: Some effort</button>
                                    <button class="score-btn" onclick="selectScoreDual('5L', 3)">3: No effort</button>
                                    <button class="score-btn" onclick="selectScoreDual('5L', 4)">4: No movement</button>
                                    <button class="score-btn" onclick="selectScoreDual('5L', 0)">X: Amputation</button>
                                </div><input type="hidden" id="val_5L" class="nihss-val require-val">
                            </div>
                        </div>
                    </div>
                    </div>
            </div>

            <button class="btn btn-success" onclick="saveAssessment()"><i class="fas fa-save"></i> ยืนยันบันทึกคะแนนเข้าระบบ</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;" class="no-print">
                <h3 style="margin:0; color: var(--primary-dark);"><i class="fas fa-folder-open"></i> แฟ้มประวัติคะแนน NIHSS</h3>
                <button class="btn btn-outline" style="padding: 5px 12px; border:none;" onclick="document.getElementById('historyModal').style.display='none'"><i class="fas fa-times" style="font-size: 20px;"></i></button>
            </div>
            
            <div id="printArea">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">รายงานประวัติคะแนน NIHSS</h3>
                    <p id="printPatientName" style="margin: 5px 0 0 0; font-size: 16px;"></p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">โรงพยาบาลสะเดา จ.สงขลา</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr>
                                <th>วัน/เวลา</th>
                                <th class="text-center">Total</th>
                                <th>1a</th><th>2</th><th>5R</th><th>5L</th>
                                <th>ผู้ประเมิน</th>
                            </tr>
                        </thead>
                        <tbody id="historyTbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end;" class="no-print">
                <button class="btn btn-outline" onclick="document.getElementById('historyModal').style.display='none'">ปิด</button>
                <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> พิมพ์ / บันทึก PDF</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby-zXVnE-y_PqjIXTQ2HqK3H04J_u6rsbXwXZ_ffK9wNG8Tf4cdvHxPAP9YyKvWRlR4/exec';
        let currentUser = null;
        let patientDirectory = [];
        let currentHistory = [];

        function toggleAuth(type) {
            document.getElementById('form-login').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('form-register').style.display = type === 'register' ? 'block' : 'none';
        }

        function navigate(page) {
            document.querySelectorAll('.main-wrapper .screen').forEach(s => s.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            
            // จัดการแสดงผล Banner
            document.getElementById('patientBanner').style.display = page === 'assess' ? 'flex' : 'none';
            
            // ซ่อน Dropdown ทุกครั้งที่เปลี่ยนหน้า
            closeAllDropdowns();
            window.scrollTo(0,0);
        }

        // --- Auth ---
        function register() {
            const phone = document.getElementById('regPhone').value;
            const pin = document.getElementById('regPin').value;
            if(!phone || pin.length !== 6) return alert('กรุณากรอกเบอร์โทร และ รหัส PIN ให้ครบ 6 หลักถ้วน');
            
            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({
                action: "register", phone: phone, pin: pin,
                name: document.getElementById('regName').value, orgType: document.getElementById('regOrgType').value, orgName: document.getElementById('regOrgName').value
            })}).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                if(res.status === 'success') { alert('ลงทะเบียนสำเร็จ'); toggleAuth('login'); }
                else alert(res.message);
            });
        }

        function login() {
            const phone = document.getElementById('logPhone').value;
            const pin = document.getElementById('logPin').value;
            if(!phone || !pin) return alert("กรุณากรอกข้อมูล");

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: "login", phone: phone, pin: pin}) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                if(res.status === 'success') {
                    currentUser = res;
                    patientDirectory = res.patients || [];
                    
                    document.getElementById('screen-login').style.display = 'none';
                    document.getElementById('app-layout').style.display = 'block';
                    navigate('search');
                } else alert(res.message);
            });
        }

        function logout() {
            document.getElementById('app-layout').style.display = 'none';
            document.getElementById('screen-login').style.display = 'block';
            document.getElementById('logPin').value = '';
        }

        // --- Custom Autocomplete (UI เรียบร้อย ทันสมัย) ---
        function filterAutocomplete(type) {
            const input = document.getElementById(type === 'hn' ? 'searchHn' : 'searchName');
            const dropdown = document.getElementById(type === 'hn' ? 'dropdownHn' : 'dropdownName');
            const val = input.value.toUpperCase();
            
            dropdown.innerHTML = '';
            if (!val) { dropdown.style.display = 'none'; return; }

            // กรองข้อมูลจาก patientDirectory
            const matches = patientDirectory.filter(p => 
                (type === 'hn' && p.hn.toUpperCase().includes(val)) || 
                (type === 'name' && p.name.toUpperCase().includes(val))
            ).slice(0, 5); // แสดงแค่ 5 รายการเพื่อไม่ให้เกะกะ

            if(matches.length === 0) { dropdown.style.display = 'none'; return; }

            matches.forEach(p => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `<strong>${p.hn}</strong> - ${p.name}`;
                div.onclick = function() {
                    document.getElementById('searchHn').value = p.hn;
                    document.getElementById('searchName').value = p.name;
                    closeAllDropdowns();
                };
                dropdown.appendChild(div);
            });
            dropdown.style.display = 'block';
        }

        function closeAllDropdowns() {
            document.getElementById('dropdownHn').style.display = 'none';
            document.getElementById('dropdownName').style.display = 'none';
        }
        // ปิด Dropdown เมื่อคลิกที่อื่น
        document.addEventListener('click', function (e) {
            if (!e.target.matches('.form-control')) closeAllDropdowns();
        });

        // --- Search & History ---
        function proceedToAssessment() {
            const hn = document.getElementById('searchHn').value;
            const name = document.getElementById('searchName').value;
            if(!hn || !name) return alert("กรุณาระบุ HN และชื่อผู้ป่วย");

            // อัปเดต Sticky Banner และ Print Header
            const patientTitle = `HN: ${hn} | ชื่อ: ${name}`;
            document.getElementById('bannerHnName').innerText = patientTitle;
            document.getElementById('printPatientName').innerText = patientTitle;
            
            document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nihss-val').forEach(i => i.value = "");
            calculateTotal();

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", hn: hn }) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                currentHistory = res.history || [];
                
                if(currentHistory.length > 0) {
                    const latest = currentHistory[0];
                    const dStr = new Date(latest.date).toLocaleDateString('th-TH');
                    document.getElementById('bannerHistoryText').innerHTML = `คะแนนครั้งก่อน: <strong style="color:var(--danger);">${latest.total}</strong> (ตรวจเมื่อ ${dStr})`;
                } else {
                    document.getElementById('bannerHistoryText').innerText = "ผู้ป่วยรายใหม่ (ยังไม่มีประวัติ)";
                }
                navigate('assess');
            });
        }

        function showHistory() {
            const tbody = document.getElementById('historyTbody');
            tbody.innerHTML = '';
            if(currentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ไม่พบประวัติการประเมิน</td></tr>';
            } else {
                currentHistory.forEach(r => {
                    const dStr = new Date(r.date).toLocaleDateString('th-TH') + ' ' + new Date(r.date).getHours() + ':' + String(new Date(r.date).getMinutes()).padStart(2,'0');
                    tbody.innerHTML += `<tr>
                        <td>${dStr}</td><td style="text-align:center;"><span class="badge">${r.total}</span></td>
                        <td>${r.s1a}</td><td>${r.s2}</td><td>${r.s5r}</td><td>${r.s5l}</td>
                        <td style="font-size:12px;">${r.assessor}</td>
                    </tr>`;
                });
            }
            document.getElementById('historyModal').style.display = 'flex';
        }

        // --- Form ---
        function selectScore(group, value) {
            document.querySelectorAll(`#group-${group} .score-btn`).forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${group}`).value = value;
            calculateTotal();
        }

        function selectScoreDual(subGroup, value) {
            document.querySelectorAll(`#group-${subGroup} .score-btn`).forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${subGroup}`).value = value;
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.nihss-val').forEach(i => { if(i.value !== "") total += parseInt(i.value); });
            document.getElementById('display-total').innerText = total;
            return total;
        }

        function saveAssessment() {
            let isValid = true; document.querySelectorAll('.require-val').forEach(i => { if(i.value === "") isValid = false; });
            if(!isValid) return alert('กรุณาประเมินให้ครบทุกหมวดก่อนบันทึก');

            const hn = document.getElementById('searchHn').value;
            const data = {
                hn: hn, patientName: document.getElementById('searchName').value,
                loc_1a: document.getElementById('val_1a').value, 
                // เพิ่มข้ออื่นๆ ตรงนี้ให้ครบครับ
                totalScore: calculateTotal(), assessorName: currentUser.name, orgFull: currentUser.orgType + " " + currentUser.orgName
            };

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "save", data: data }) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                alert('บันทึกข้อมูลคะแนนเรียบร้อย');
                
                // อัปเดตรายชื่อเผื่อเป็นคนใหม่
                if(!patientDirectory.find(p => p.hn === hn)) {
                    patientDirectory.push({hn: hn, name: data.patientName});
                }
                
                document.getElementById('searchHn').value = ''; document.getElementById('searchName').value = '';
                navigate('search');
            });
        }
    </script>
</body>
</html>
