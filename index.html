<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIHSS Smart Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0f766e; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg-color: #f3f4f6; --surface: #ffffff; --text-main: #1f2937; --text-muted: #6b7280; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); }
        
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease; padding: 20px; box-sizing: border-box; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* แถบ Patient Profile Banner (ลอยอยู่ด้านบน) */
        .patient-banner { background: var(--primary); color: white; padding: 15px 20px; border-radius: 12px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 15px rgba(15, 118, 110, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .patient-info h2 { margin: 0; font-size: 18px; }
        .patient-info p { margin: 5px 0 0 0; font-size: 13px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; display: inline-block; }
        .btn-history { background: white; color: var(--primary); border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; font-family: 'Sarabun'; cursor: pointer; font-size: 13px; }

        /* Cards & Inputs */
        .glass-card { background: var(--surface); border-radius: 16px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { font-weight: 600; font-size: 14px; margin-bottom: 8px; display: block; color: var(--text-muted); }
        input, select { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 10px; font-family: 'Sarabun'; font-size: 16px; background: #f9fafb; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; background: white; }
        
        /* Buttons */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 600; font-size: 16px; width: 100%; cursor: pointer; display: flex; justify-content: center; gap: 10px; font-family: 'Sarabun'; }
        
        /* Modals & History Table */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(17, 24, 39, 0.7); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--surface); padding: 25px; border-radius: 16px; width: 95%; max-width: 600px; max-height: 85vh; overflow-y: auto; text-align: center; }
        
        /* ตารางประวัติ NIHSS */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; text-align: center; }
        .history-table th { background: #f3f4f6; padding: 10px 5px; color: var(--text-muted); position: sticky; top: 0; }
        .history-table td { padding: 10px 5px; border-bottom: 1px solid #e5e7eb; }
        .history-table tr:hover { background: #f9fafb; }
        .score-badge { background: #fee2e2; color: #b91c1c; font-weight: bold; padding: 4px 8px; border-radius: 6px; }

        /* Score UI */
        .section-card { background: var(--surface); border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 20px; overflow: hidden; max-width: 600px; margin-left: auto; margin-right: auto;}
        .section-header { background: #f9fafb; padding: 15px; font-weight: 600; color: var(--primary); border-bottom: 1px solid #e5e7eb; }
        .section-body { padding: 20px; }
        .score-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;}
        .score-btn { padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; text-align: left; font-size: 14px; display: flex; align-items: center; font-family: 'Sarabun'; }
        .score-btn.active { background: #f0fdfa; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .score-number { background: #f3f4f6; padding: 2px 8px; border-radius: 6px; margin-right: 12px; font-weight: bold; }
        .score-btn.active .score-number { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <datalist id="hnList"></datalist>
    <datalist id="nameList"></datalist>

    <div id="loadingModal" class="modal-overlay"><div class="modal-content" style="width: auto;"><i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary);"></i><div style="margin-top:10px;">กำลังโหลดข้อมูล...</div></div></div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color: var(--primary);"><i class="fas fa-history"></i> ประวัติคะแนน NIHSS</h3>
            <div style="font-weight: 600;" id="historyPatientName">ชื่อผู้ป่วย</div>
            <div style="overflow-x: auto;">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>ว/ด/ป เวลา</th>
                            <th>Total</th>
                            <th>1a</th><th>1b</th><th>1c</th><th>2</th><th>3</th><th>4</th>
                            <th>5R</th><th>5L</th><th>6R</th><th>6L</th>
                            <th>ผู้ประเมิน</th>
                        </tr>
                    </thead>
                    <tbody id="historyTbody">
                        </tbody>
                </table>
            </div>
            <button class="btn-primary" style="margin-top: 20px; background: var(--text-muted);" onclick="document.getElementById('historyModal').style.display='none'">ปิดหน้าต่าง</button>
        </div>
    </div>

    <div id="screen-login" class="screen active" style="display: flex; flex-direction: column; justify-content: center;">
        <div style="text-align: center; margin-bottom: 30px;"><i class="fas fa-heartbeat" style="font-size: 50px; color: var(--primary);"></i><h1 style="margin:0; color: var(--primary);">NIHSS Smart</h1></div>
        <div class="glass-card">
            <div class="input-group"><label>เบอร์โทรศัพท์เจ้าหน้าที่</label><input type="tel" id="logPhone" placeholder="08XXXXXXXX"></div>
            <div class="input-group"><label>รหัส PIN</label><input type="password" id="logPin" placeholder="PIN 6 หลัก"></div>
            <button class="btn-primary" onclick="login()">เข้าสู่ระบบ</button>
        </div>
    </div>

    <div id="screen-search" class="screen">
        <div style="text-align: center; margin-bottom: 20px; color: var(--primary);">
            <i class="fas fa-search" style="font-size: 40px;"></i>
            <h2>ค้นหาและระบุตัวผู้ป่วย</h2>
        </div>
        <div class="glass-card">
            <div class="input-group">
                <label>HN ผู้ป่วย</label>
                <input type="text" id="searchHn" list="hnList" placeholder="พิมพ์ HN เพื่อค้นหา" oninput="autofillSearch('hn')">
            </div>
            <div style="text-align: center; margin: 10px 0; color: var(--text-muted);">หรือ</div>
            <div class="input-group">
                <label>ชื่อ-สกุล</label>
                <input type="text" id="searchName" list="nameList" placeholder="พิมพ์ชื่อเพื่อค้นหา" oninput="autofillSearch('name')">
            </div>
            <button class="btn-primary" style="margin-top: 20px;" onclick="proceedToAssessment()"><i class="fas fa-user-check"></i> ยืนยันผู้ป่วย & ดึงประวัติ</button>
            <button class="btn-primary" style="background: transparent; border: 1px solid var(--danger); color: var(--danger); margin-top: 10px;" onclick="switchScreen('screen-login')">ออกจากระบบ</button>
        </div>
    </div>

    <div id="screen-assess" class="screen">
        
        <div class="patient-banner">
            <div class="patient-info">
                <h2 id="bannerName">HN: 12345 | ชื่อผู้ป่วย</h2>
                <p id="bannerLatest"><i class="fas fa-info-circle"></i> ล่าสุด: 0 คะแนน (ประเมินครั้งแรก)</p>
            </div>
            <button class="btn-history" onclick="document.getElementById('historyModal').style.display='flex'"><i class="fas fa-chart-line"></i> ดูประวัติ</button>
        </div>

        <div style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 15px; color: var(--primary);">
            คะแนนรวมปัจจุบัน: <span id="display-total" style="font-size: 30px;">0</span>
        </div>

        <div class="section-card">
            <div class="section-header"><i class="fas fa-brain"></i> หมวด 1: การประเมินระดับความรู้สึกตัว (LOC)</div>
            <div class="section-body">
                <label>1a. Level of Consciousness</label>
                <div class="score-group" id="group-1a">
                    <button class="score-btn" onclick="selectScore('1a', 0)"><span class="score-number">0</span> Alert</button>
                    <button class="score-btn" onclick="selectScore('1a', 1)"><span class="score-number">1</span> Drowsy</button>
                    <button class="score-btn" onclick="selectScore('1a', 2)"><span class="score-number">2</span> Stuporous</button>
                    <button class="score-btn" onclick="selectScore('1a', 3)"><span class="score-number">3</span> Coma</button>
                </div><input type="hidden" id="val_1a" class="nihss-val require-val">
            </div>
        </div>

        <div style="max-width: 600px; margin: 0 auto; display: flex; gap: 10px; margin-bottom: 50px;">
            <button class="btn-primary" style="background: #e5e7eb; color: var(--text-main); flex: 1;" onclick="switchScreen('screen-search')">ยกเลิก/เปลี่ยนคน</button>
            <button class="btn-primary" style="background: var(--success); flex: 2;" onclick="saveAssessment()"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby-zXVnE-y_PqjIXTQ2HqK3H04J_u6rsbXwXZ_ffK9wNG8Tf4cdvHxPAP9YyKvWRlR4/exec';
        let currentUser = null;
        let currentPatientHistory = []; // เก็บประวัติรายข้อของคนไข้ปัจจุบัน
        let patientDirectory = [];

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0,0);
        }

        // --- Auth & Setup ---
        function login() {
            const phone = document.getElementById('logPhone').value;
            const pin = document.getElementById('logPin').value;
            if(!phone || !pin) return alert("กรุณากรอกข้อมูลให้ครบ");

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: "login", phone: phone, pin: pin}) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                if(res.status === 'success') {
                    currentUser = res;
                    patientDirectory = res.patients || [];
                    const hnList = document.getElementById('hnList'); const nameList = document.getElementById('nameList');
                    hnList.innerHTML = ''; nameList.innerHTML = '';
                    patientDirectory.forEach(p => { hnList.innerHTML += `<option value="${p.hn}">${p.name}</option>`; nameList.innerHTML += `<option value="${p.name}">${p.hn}</option>`; });
                    
                    document.getElementById('logPin').value = '';
                    switchScreen('screen-search'); // เปลี่ยนไปหน้าค้นหาคนไข้
                } else alert(res.message);
            });
        }

        function autofillSearch(source) {
            const hnInput = document.getElementById('searchHn'); const nameInput = document.getElementById('searchName');
            if(source === 'hn') { const matched = patientDirectory.find(p => p.hn === hnInput.value); if(matched) nameInput.value = matched.name; }
            else if (source === 'name') { const matched = patientDirectory.find(p => p.name === nameInput.value); if(matched) hnInput.value = matched.hn; }
        }

        // --- Step 2: Proceed and Fetch Profile ---
        function proceedToAssessment() {
            const hn = document.getElementById('searchHn').value;
            const name = document.getElementById('searchName').value;
            if(!hn || !name) return alert("กรุณาระบุ HN และชื่อผู้ป่วย");

            // อัปเดตข้อมูลบน Banner
            document.getElementById('bannerName').innerText = `HN: ${hn} | ${name}`;
            document.getElementById('historyPatientName').innerText = `ประวัติคะแนนของคุณ: ${name}`;

            // ล้างฟอร์มเก่าเผื่อมีการประเมินค้างไว้
            document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nihss-val').forEach(i => i.value = "");
            calculateTotal();

            document.getElementById('loadingModal').style.display = 'flex';
            
            // ดึงประวัติละเอียดจากระบบ
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", hn: hn }) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                currentPatientHistory = res.history || [];
                
                const tbody = document.getElementById('historyTbody');
                tbody.innerHTML = '';

                if(currentPatientHistory.length > 0) {
                    const latest = currentPatientHistory[0];
                    const dateObj = new Date(latest.date);
                    const dStr = dateObj.toLocaleDateString('th-TH') + " " + String(dateObj.getHours()).padStart(2,'0') + ":" + String(dateObj.getMinutes()).padStart(2,'0');
                    
                    // อัปเดต Banner ว่าล่าสุดเท่าไหร่
                    document.getElementById('bannerLatest').innerHTML = `<i class="fas fa-exclamation-circle"></i> ล่าสุด: <span class="score-badge">${latest.total} คะแนน</span> (เมื่อ ${dStr})`;

                    // วาดตารางประวัติละเอียด
                    currentPatientHistory.forEach(row => {
                        const rDate = new Date(row.date);
                        const rStr = rDate.toLocaleDateString('th-TH',{day:'numeric',month:'short'}) + " " + String(rDate.getHours()).padStart(2,'0') + ":" + String(rDate.getMinutes()).padStart(2,'0');
                        tbody.innerHTML += `
                            <tr>
                                <td style="white-space:nowrap;">${rStr}</td>
                                <td><span class="score-badge">${row.total}</span></td>
                                <td>${row.s1a}</td><td>${row.s1b}</td><td>${row.s1c}</td><td>${row.s2}</td><td>${row.s3}</td><td>${row.s4}</td>
                                <td>${row.s5r}</td><td>${row.s5l}</td><td>${row.s6r}</td><td>${row.s6l}</td>
                                <td style="font-size:11px;">${row.assessor}</td>
                            </tr>
                        `;
                    });

                } else {
                    document.getElementById('bannerLatest').innerHTML = `<i class="fas fa-info-circle"></i> การประเมินครั้งแรก`;
                    tbody.innerHTML = `<tr><td colspan="13">ไม่พบประวัติการประเมิน</td></tr>`;
                }

                switchScreen('screen-assess'); // เข้าสู่พื้นที่ประเมิน
            });
        }

        // --- Form Logic ---
        function selectScore(group, value) {
            document.querySelectorAll(`#group-${group} .score-btn`).forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`val_${group}`).value = value;
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.nihss-val').forEach(input => { if(input.value !== "") total += parseInt(input.value); });
            document.getElementById('display-total').innerText = total;
            return total;
        }

        function saveAssessment() {
            let isValid = true; document.querySelectorAll('.require-val').forEach(input => { if(input.value === "") isValid = false; });
            if(!isValid) return alert('กรุณาประเมินให้ครบทุกหมวดก่อนบันทึก');

            const hn = document.getElementById('searchHn').value;
            const data = {
                hn: hn, patientName: document.getElementById('searchName').value,
                loc_1a: document.getElementById('val_1a').value, 
                // เพิ่มการดึงค่า 1b-6 ตรงนี้ให้ครบนะครับ
                totalScore: calculateTotal(), assessorName: currentUser.name, orgFull: currentUser.orgType + " " + currentUser.orgName
            };

            document.getElementById('loadingModal').style.display = 'flex';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "save", data: data }) }).then(r => r.json()).then(res => {
                document.getElementById('loadingModal').style.display = 'none';
                alert(`บันทึกคะแนน ${data.totalScore} ของ ${data.patientName} สำเร็จ!`);
                
                // อัปเดต Datalist เผื่อเป็นเคสใหม่
                if(!patientDirectory.find(p => p.hn === hn)) {
                    patientDirectory.push({hn: hn, name: data.patientName});
                }
                
                // ล้างข้อมูลหน้าค้นหา แล้วเด้งกลับไปรับเคสถัดไป
                document.getElementById('searchHn').value = ''; document.getElementById('searchName').value = '';
                switchScreen('screen-search'); 
            });
        }
    </script>
</body>
</html>
